<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Music Player</title>
    <style>
        body { font-family: monospace; padding: 2em; background: #1a1a1a; color: #eee; }
        button { font-size: 1.2em; padding: 0.5em 1.5em; margin: 0.5em; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #status { margin: 1em 0; color: #aaa; }

        .container { display: flex; gap: 2em; flex-wrap: wrap; }
        .left-panel { flex: 1; min-width: 300px; }
        .right-panel { flex: 1; min-width: 400px; }

        .progress-container { margin: 1em 0; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a9eff, #00d4aa);
            width: 0%;
            transition: width 0.1s;
        }
        .progress-text { margin-top: 0.5em; text-align: center; font-size: 0.9em; }

        .piano {
            display: flex;
            gap: 3px;
            margin: 1em 0;
            justify-content: center;
        }
        .key {
            width: 40px;
            height: 100px;
            background: #444;
            border-radius: 0 0 5px 5px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 6px;
            font-size: 0.8em;
            transition: all 0.1s;
        }
        .key.active {
            background: linear-gradient(180deg, #00d4aa, #00a080);
            box-shadow: 0 0 15px #00d4aa88;
        }

        .note-info {
            text-align: center;
            font-size: 1.3em;
            margin: 0.5em 0;
            min-height: 1.5em;
        }
        .freq { color: #4a9eff; }

        /* Circuit Diagram */
        .circuit-container {
            background: #222;
            border-radius: 8px;
            padding: 1em;
        }
        .circuit-title {
            text-align: center;
            margin-bottom: 0.5em;
            color: #888;
        }
        .circuit svg {
            width: 100%;
            height: auto;
        }
        .wire { stroke: #555; stroke-width: 2; fill: none; }
        .wire.active { stroke: #00d4aa; stroke-width: 2.5; }
        .component { fill: #444; stroke: #666; stroke-width: 1.5; }
        .component.active { fill: #00a080; stroke: #00d4aa; }
        .component-label { fill: #aaa; font-size: 10px; text-anchor: middle; }
        .component-label.active { fill: #fff; }
        .decoder-out { fill: #333; }
        .decoder-out.active { fill: #00d4aa; }
        .transistor { fill: #444; stroke: #666; }
        .transistor.active { fill: #00a080; stroke: #00d4aa; }
        .resistor { fill: none; stroke: #666; stroke-width: 2; }
        .resistor.active { stroke: #00d4aa; stroke-width: 3; }
        .timer-indicator { fill: #333; }
        .timer-indicator.on { fill: #ff6b6b; }
        .speaker-cone { fill: #555; stroke: #777; }
        .speaker-cone.active { fill: #666; animation: vibrate 0.05s infinite; }
        @keyframes vibrate {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(2px); }
        }
    </style>
</head>
<body>
    <h1>Music Player - Verilog + 555 Timer</h1>

    <div class="container">
        <div class="left-panel">
            <div class="piano" id="piano">
                <div class="key" data-note="0">Do</div>
                <div class="key" data-note="1">Re</div>
                <div class="key" data-note="2">Mi</div>
                <div class="key" data-note="3">Fa</div>
                <div class="key" data-note="4">Sol</div>
                <div class="key" data-note="5">La</div>
                <div class="key" data-note="6">Si</div>
                <div class="key" data-note="7">Do'</div>
            </div>

            <div class="note-info" id="noteInfo"></div>

            <div class="progress-container">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text" id="progressText">0%</div>
            </div>

            <button id="play" disabled>Play</button>
            <button id="download" disabled>Download WAV</button>
            <div id="status">Loading WASM...</div>
        </div>

        <div class="right-panel">
            <div class="circuit-container">
                <div class="circuit-title">Circuit Diagram</div>
                <div class="circuit">
                    <svg viewBox="0 0 500 320" id="circuitSvg">
                        <!-- Verilog Module -->
                        <rect x="10" y="100" width="70" height="120" class="component" id="verilog"/>
                        <text x="45" y="155" class="component-label">Verilog</text>
                        <text x="45" y="170" class="component-label">music_player</text>
                        <text x="45" y="190" class="component-label" id="noteCode">note: -</text>

                        <!-- 3-to-8 Decoder -->
                        <rect x="120" y="80" width="60" height="160" class="component" id="decoder"/>
                        <text x="150" y="105" class="component-label">3-to-8</text>
                        <text x="150" y="120" class="component-label">Decoder</text>

                        <!-- Decoder outputs -->
                        <g id="decoderOutputs">
                            <circle cx="180" cy="100" r="5" class="decoder-out" data-out="0"/>
                            <circle cx="180" cy="120" r="5" class="decoder-out" data-out="1"/>
                            <circle cx="180" cy="140" r="5" class="decoder-out" data-out="2"/>
                            <circle cx="180" cy="160" r="5" class="decoder-out" data-out="3"/>
                            <circle cx="180" cy="180" r="5" class="decoder-out" data-out="4"/>
                            <circle cx="180" cy="200" r="5" class="decoder-out" data-out="5"/>
                            <circle cx="180" cy="220" r="5" class="decoder-out" data-out="6"/>
                            <circle cx="180" cy="240" r="5" class="decoder-out" data-out="7"/>
                        </g>

                        <!-- Wires from Verilog to Decoder -->
                        <path d="M80 160 L120 160" class="wire" id="wireVtoD"/>

                        <!-- Transistors -->
                        <g id="transistors">
                            <g class="transistor-group" data-t="0">
                                <line x1="185" y1="100" x2="210" y2="100" class="wire" data-w="0"/>
                                <rect x="210" y="92" width="20" height="16" class="transistor" data-t="0"/>
                                <text x="220" y="103" class="component-label" style="font-size:8px">T0</text>
                            </g>
                            <g class="transistor-group" data-t="1">
                                <line x1="185" y1="120" x2="210" y2="120" class="wire" data-w="1"/>
                                <rect x="210" y="112" width="20" height="16" class="transistor" data-t="1"/>
                                <text x="220" y="123" class="component-label" style="font-size:8px">T1</text>
                            </g>
                            <g class="transistor-group" data-t="2">
                                <line x1="185" y1="140" x2="210" y2="140" class="wire" data-w="2"/>
                                <rect x="210" y="132" width="20" height="16" class="transistor" data-t="2"/>
                                <text x="220" y="143" class="component-label" style="font-size:8px">T2</text>
                            </g>
                            <g class="transistor-group" data-t="3">
                                <line x1="185" y1="160" x2="210" y2="160" class="wire" data-w="3"/>
                                <rect x="210" y="152" width="20" height="16" class="transistor" data-t="3"/>
                                <text x="220" y="163" class="component-label" style="font-size:8px">T3</text>
                            </g>
                            <g class="transistor-group" data-t="4">
                                <line x1="185" y1="180" x2="210" y2="180" class="wire" data-w="4"/>
                                <rect x="210" y="172" width="20" height="16" class="transistor" data-t="4"/>
                                <text x="220" y="183" class="component-label" style="font-size:8px">T4</text>
                            </g>
                            <g class="transistor-group" data-t="5">
                                <line x1="185" y1="200" x2="210" y2="200" class="wire" data-w="5"/>
                                <rect x="210" y="192" width="20" height="16" class="transistor" data-t="5"/>
                                <text x="220" y="203" class="component-label" style="font-size:8px">T5</text>
                            </g>
                            <g class="transistor-group" data-t="6">
                                <line x1="185" y1="220" x2="210" y2="220" class="wire" data-w="6"/>
                                <rect x="210" y="212" width="20" height="16" class="transistor" data-t="6"/>
                                <text x="220" y="223" class="component-label" style="font-size:8px">T6</text>
                            </g>
                            <g class="transistor-group" data-t="7">
                                <line x1="185" y1="240" x2="210" y2="240" class="wire" data-w="7"/>
                                <rect x="210" y="232" width="20" height="16" class="transistor" data-t="7"/>
                                <text x="220" y="243" class="component-label" style="font-size:8px">T7</text>
                            </g>
                        </g>

                        <!-- Resistors -->
                        <g id="resistors">
                            <g data-r="0"><line x1="230" y1="100" x2="245" y2="100" class="wire"/><path d="M245 100 l5 -5 l5 10 l5 -10 l5 10 l5 -10 l5 10 l5 -5" class="resistor" data-r="0"/><text x="270" y="95" class="component-label" style="font-size:7px">R0</text></g>
                            <g data-r="1"><line x1="230" y1="120" x2="245" y2="120" class="wire"/><path d="M245 120 l5 -5 l5 10 l5 -10 l5 10 l5 -10 l5 10 l5 -5" class="resistor" data-r="1"/><text x="270" y="115" class="component-label" style="font-size:7px">R1</text></g>
                            <g data-r="2"><line x1="230" y1="140" x2="245" y2="140" class="wire"/><path d="M245 140 l5 -5 l5 10 l5 -10 l5 10 l5 -10 l5 10 l5 -5" class="resistor" data-r="2"/><text x="270" y="135" class="component-label" style="font-size:7px">R2</text></g>
                            <g data-r="3"><line x1="230" y1="160" x2="245" y2="160" class="wire"/><path d="M245 160 l5 -5 l5 10 l5 -10 l5 10 l5 -10 l5 10 l5 -5" class="resistor" data-r="3"/><text x="270" y="155" class="component-label" style="font-size:7px">R3</text></g>
                            <g data-r="4"><line x1="230" y1="180" x2="245" y2="180" class="wire"/><path d="M245 180 l5 -5 l5 10 l5 -10 l5 10 l5 -10 l5 10 l5 -5" class="resistor" data-r="4"/><text x="270" y="175" class="component-label" style="font-size:7px">R4</text></g>
                            <g data-r="5"><line x1="230" y1="200" x2="245" y2="200" class="wire"/><path d="M245 200 l5 -5 l5 10 l5 -10 l5 10 l5 -10 l5 10 l5 -5" class="resistor" data-r="5"/><text x="270" y="195" class="component-label" style="font-size:7px">R5</text></g>
                            <g data-r="6"><line x1="230" y1="220" x2="245" y2="220" class="wire"/><path d="M245 220 l5 -5 l5 10 l5 -10 l5 10 l5 -10 l5 10 l5 -5" class="resistor" data-r="6"/><text x="270" y="215" class="component-label" style="font-size:7px">R6</text></g>
                            <g data-r="7"><line x1="230" y1="240" x2="245" y2="240" class="wire"/><path d="M245 240 l5 -5 l5 10 l5 -10 l5 10 l5 -10 l5 10 l5 -5" class="resistor" data-r="7"/><text x="270" y="235" class="component-label" style="font-size:7px">R7</text></g>
                        </g>

                        <!-- Common bus -->
                        <line x1="290" y1="100" x2="310" y2="100" class="wire"/>
                        <line x1="290" y1="120" x2="310" y2="120" class="wire"/>
                        <line x1="290" y1="140" x2="310" y2="140" class="wire"/>
                        <line x1="290" y1="160" x2="310" y2="160" class="wire"/>
                        <line x1="290" y1="180" x2="310" y2="180" class="wire"/>
                        <line x1="290" y1="200" x2="310" y2="200" class="wire"/>
                        <line x1="290" y1="220" x2="310" y2="220" class="wire"/>
                        <line x1="290" y1="240" x2="310" y2="240" class="wire"/>
                        <line x1="310" y1="100" x2="310" y2="240" class="wire"/>
                        <line x1="310" y1="170" x2="340" y2="170" class="wire" id="wireBus"/>

                        <!-- 555 Timer -->
                        <rect x="340" y="130" width="70" height="80" class="component" id="timer555"/>
                        <text x="375" y="160" class="component-label">555</text>
                        <text x="375" y="175" class="component-label">Timer</text>
                        <circle cx="375" cy="195" r="8" class="timer-indicator" id="timerLed"/>

                        <!-- Output to speaker -->
                        <line x1="410" y1="170" x2="440" y2="170" class="wire" id="wireOut"/>

                        <!-- Speaker -->
                        <g id="speaker">
                            <rect x="440" y="155" width="15" height="30" class="component"/>
                            <polygon points="455,145 480,125 480,215 455,195" class="speaker-cone" id="speakerCone"/>
                        </g>

                        <!-- Labels -->
                        <text x="45" y="240" class="component-label" style="font-size:9px">FPGA</text>
                        <text x="460" y="240" class="component-label" style="font-size:9px">Speaker</text>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        const NOTE_NAMES = ['Do', 'Re', 'Mi', 'Fa', 'Sol', 'La', 'Si', "Do'"];
        const keys = document.querySelectorAll('.key');
        let timerInterval = null;
        let timerState = false;

        window.onSimProgress = function(ms, totalMs, note, rest, freq) {
            const percent = Math.round((ms / totalMs) * 100);
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `${percent}% (${ms}ms / ${totalMs}ms)`;

            keys.forEach((key, i) => {
                key.classList.remove('active');
                if (!rest && i === note) key.classList.add('active');
            });

            if (rest) {
                document.getElementById('noteInfo').innerHTML = '<span style="color:#666">REST</span>';
            } else {
                document.getElementById('noteInfo').innerHTML =
                    `${NOTE_NAMES[note]} <span class="freq">${freq}Hz</span>`;
            }
        };

        window.onCircuitUpdate = function(note, rest) {
            // Update note code display
            document.getElementById('noteCode').textContent = rest ? 'note: REST' : `note: ${note}`;

            // Update decoder outputs
            document.querySelectorAll('.decoder-out').forEach((el, i) => {
                el.classList.toggle('active', !rest && i === note);
            });

            // Update transistors
            document.querySelectorAll('.transistor').forEach((el) => {
                const t = parseInt(el.dataset.t);
                el.classList.toggle('active', !rest && t === note);
            });

            // Update wires to transistors
            document.querySelectorAll('[data-w]').forEach((el) => {
                const w = parseInt(el.dataset.w);
                el.classList.toggle('active', !rest && w === note);
            });

            // Update resistors
            document.querySelectorAll('.resistor').forEach((el) => {
                const r = parseInt(el.dataset.r);
                el.classList.toggle('active', !rest && r === note);
            });

            // Update bus and output wires
            document.getElementById('wireBus').classList.toggle('active', !rest);
            document.getElementById('wireOut').classList.toggle('active', !rest);
            document.getElementById('wireVtoD').classList.toggle('active', !rest);

            // Update Verilog module
            document.getElementById('verilog').classList.toggle('active', !rest);
            document.getElementById('decoder').classList.toggle('active', !rest);
            document.getElementById('timer555').classList.toggle('active', !rest);

            // Update speaker
            document.getElementById('speakerCone').classList.toggle('active', !rest);

            // Timer LED blinking
            if (timerInterval) clearInterval(timerInterval);
            if (!rest) {
                timerInterval = setInterval(() => {
                    timerState = !timerState;
                    document.getElementById('timerLed').classList.toggle('on', timerState);
                }, 50);
            } else {
                document.getElementById('timerLed').classList.remove('on');
            }
        };

        var Module = {
            onRuntimeInitialized: function() {
                document.getElementById('status').textContent = 'Ready';
                document.getElementById('play').disabled = false;
            }
        };

        document.getElementById('play').onclick = async function() {
            document.getElementById('status').textContent = 'Playing...';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            document.getElementById('play').disabled = true;
            await new Promise(r => setTimeout(r, 10));

            Module._web_run();

            document.getElementById('status').textContent = 'Finished';
            document.getElementById('play').disabled = false;
            document.getElementById('download').disabled = false;
            keys.forEach(key => key.classList.remove('active'));
            document.getElementById('noteInfo').innerHTML = '';

            // Reset circuit
            if (timerInterval) clearInterval(timerInterval);
            document.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
            document.getElementById('timerLed').classList.remove('on');
            document.getElementById('speakerCone').classList.remove('active');
        };

        document.getElementById('download').onclick = function() {
            const data = FS.readFile('/output.wav');
            const blob = new Blob([data], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'music_555.wav';
            a.click();
            URL.revokeObjectURL(url);
        };
    </script>
    <script src="music_player.js"></script>
</body>
</html>
